<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchCraft - MediaPipe íˆ¬êµ¬ í¼ ë¶„ì„ ë°ëª¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #f8fafc;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00e676, #2979ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .video-section {
            background: #1e293b;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #webcam, #canvas {
            width: 100%;
            display: block;
            border-radius: 12px;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #00e676;
            color: #0f172a;
        }
        
        .btn-primary:hover {
            background: #00c853;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #334155;
            color: #f8fafc;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stat-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #00e676;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-name {
            font-size: 14px;
            color: #cbd5e1;
        }
        
        .stat-num {
            font-size: 18px;
            font-weight: 700;
            color: #00e676;
        }
        
        .stat-num.warning {
            color: #ffb74d;
        }
        
        .stat-num.danger {
            color: #ff5252;
        }
        
        .phase-indicator {
            display: flex;
            gap: 5px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .phase {
            padding: 6px 12px;
            background: #334155;
            border-radius: 20px;
            font-size: 11px;
            color: #94a3b8;
            transition: all 0.3s;
        }
        
        .phase.active {
            background: #00e676;
            color: #0f172a;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #00e676;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #334155;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #64748b;
        }
        
        .status-dot.active {
            background: #00e676;
            box-shadow: 0 0 10px #00e676;
        }
        
        .info-box {
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
            color: #a7f3d0;
        }
        
        .error-box {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            color: #fca5a5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¾ PitchCraft AI í¼ ë¶„ì„</h1>
        <p class="subtitle">MediaPipe Poseë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ íˆ¬êµ¬ í¼ ë¶„ì„ ë°ëª¨</p>
        
        <div class="main-grid">
            <!-- ë¹„ë””ì˜¤ ì„¹ì…˜ -->
            <div class="video-section">
                <div class="status-badge">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">ëŒ€ê¸° ì¤‘</span>
                </div>
                
                <div class="video-container">
                    <video id="webcam" playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="startBtn" onclick="startCamera()">
                        ğŸ“· ì¹´ë©”ë¼ ì‹œì‘
                    </button>
                    <button class="btn btn-secondary" id="captureBtn" onclick="captureFrame()" disabled>
                        ğŸ“¸ í”„ë ˆì„ ìº¡ì²˜
                    </button>
                    <button class="btn btn-secondary" id="stopBtn" onclick="stopCamera()" disabled>
                        â¹ï¸ ì¤‘ì§€
                    </button>
                </div>
                
                <div class="info-box">
                    <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•</strong><br>
                    1. 'ì¹´ë©”ë¼ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”<br>
                    2. ì¹´ë©”ë¼ ì•ì—ì„œ íˆ¬êµ¬ ìì„¸ë¥¼ ì·¨í•˜ì„¸ìš”<br>
                    3. ê´€ì ˆì´ ì´ˆë¡ìƒ‰ ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤<br>
                    4. ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì‹¤ì‹œê°„ ì¸¡ì •ê°’ì„ í™•ì¸í•˜ì„¸ìš”
                </div>
                
                <div id="errorBox" class="error-box" style="display: none;"></div>
            </div>
            
            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="stats-section">
                <!-- íˆ¬êµ¬ ë‹¨ê³„ -->
                <div class="stat-card">
                    <h3>ğŸ“Š í˜„ì¬ íˆ¬êµ¬ ë‹¨ê³„</h3>
                    <div class="stat-value" id="currentPhase">--</div>
                    <div class="stat-label">ê°ì§€ëœ ë‹¨ê³„</div>
                    <div class="phase-indicator">
                        <span class="phase" data-phase="1">Wind-up</span>
                        <span class="phase" data-phase="2">Leg Lift</span>
                        <span class="phase" data-phase="3">Stride</span>
                        <span class="phase" data-phase="4">Arm Cock</span>
                        <span class="phase" data-phase="5">Release</span>
                        <span class="phase" data-phase="6">Follow</span>
                    </div>
                </div>
                
                <!-- ì¸¡ì •ê°’ -->
                <div class="stat-card">
                    <h3>ğŸ“ ì‹¤ì‹œê°„ ì¸¡ì •</h3>
                    <div class="stat-row">
                        <span class="stat-name">íŒ”ê¿ˆì¹˜ ê°ë„</span>
                        <span class="stat-num" id="elbowAngle">--Â°</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ì–´ê¹¨ ê°ë„</span>
                        <span class="stat-num" id="shoulderAngle">--Â°</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ë¬´ë¦ ê°ë„</span>
                        <span class="stat-num" id="kneeAngle">--Â°</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ëª¸í†µ ê¸°ìš¸ê¸°</span>
                        <span class="stat-num" id="torsoTilt">--Â°</span>
                    </div>
                </div>
                
                <!-- ê´€ì ˆ ê°ì§€ ìƒíƒœ -->
                <div class="stat-card">
                    <h3>ğŸ¦´ ê´€ì ˆ ê°ì§€ ìƒíƒœ</h3>
                    <div class="stat-row">
                        <span class="stat-name">ê°ì§€ëœ ê´€ì ˆ</span>
                        <span class="stat-num" id="detectedJoints">0/33</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ì‹ ë¢°ë„</span>
                        <span class="stat-num" id="confidence">--%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">FPS</span>
                        <span class="stat-num" id="fps">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <script>
        // DOM Elements
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const errorBox = document.getElementById('errorBox');
        
        // State
        let pose = null;
        let camera = null;
        let isRunning = false;
        let frameCount = 0;
        let lastTime = performance.now();
        
        // MediaPipe Pose ëœë“œë§ˆí¬ ì¸ë±ìŠ¤
        const LANDMARKS = {
            NOSE: 0,
            LEFT_SHOULDER: 11,
            RIGHT_SHOULDER: 12,
            LEFT_ELBOW: 13,
            RIGHT_ELBOW: 14,
            LEFT_WRIST: 15,
            RIGHT_WRIST: 16,
            LEFT_HIP: 23,
            RIGHT_HIP: 24,
            LEFT_KNEE: 25,
            RIGHT_KNEE: 26,
            LEFT_ANKLE: 27,
            RIGHT_ANKLE: 28
        };
        
        // ê°ë„ ê³„ì‚° í•¨ìˆ˜
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            return Math.round(angle);
        }
        
        // íˆ¬êµ¬ ë‹¨ê³„ ê°ì§€
        function detectPhase(landmarks) {
            if (!landmarks || landmarks.length < 33) return '--';
            
            const rightWrist = landmarks[LANDMARKS.RIGHT_WRIST];
            const rightShoulder = landmarks[LANDMARKS.RIGHT_SHOULDER];
            const rightHip = landmarks[LANDMARKS.RIGHT_HIP];
            const leftKnee = landmarks[LANDMARKS.LEFT_KNEE];
            const leftAnkle = landmarks[LANDMARKS.LEFT_ANKLE];
            const rightAnkle = landmarks[LANDMARKS.RIGHT_ANKLE];
            
            // ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±ìœ¼ë¡œ ë‹¨ê³„ ê°ì§€
            const kneeHeight = rightHip.y - leftKnee.y;
            const wristHeight = rightShoulder.y - rightWrist.y;
            const stanceWidth = Math.abs(leftAnkle.x - rightAnkle.x);
            
            // ë‹¨ê³„ íŒë³„
            if (kneeHeight > 0.15) {
                updatePhaseIndicator(2);
                return 'Leg Lift';
            } else if (stanceWidth > 0.3) {
                updatePhaseIndicator(3);
                return 'Stride';
            } else if (wristHeight > 0.2) {
                updatePhaseIndicator(4);
                return 'Arm Cock';
            } else if (wristHeight < -0.1) {
                updatePhaseIndicator(5);
                return 'Release';
            } else {
                updatePhaseIndicator(1);
                return 'Wind-up';
            }
        }
        
        function updatePhaseIndicator(activePhase) {
            document.querySelectorAll('.phase').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.phase) === activePhase) {
                    el.classList.add('active');
                }
            });
        }
        
        // ì¸¡ì •ê°’ ì—…ë°ì´íŠ¸
        function updateMeasurements(landmarks) {
            if (!landmarks || landmarks.length < 33) return;
            
            // íŒ”ê¿ˆì¹˜ ê°ë„ (ì˜¤ë¥¸íŒ”)
            const elbowAngle = calculateAngle(
                landmarks[LANDMARKS.RIGHT_SHOULDER],
                landmarks[LANDMARKS.RIGHT_ELBOW],
                landmarks[LANDMARKS.RIGHT_WRIST]
            );
            const elbowEl = document.getElementById('elbowAngle');
            elbowEl.textContent = `${elbowAngle}Â°`;
            elbowEl.className = 'stat-num' + (elbowAngle < 70 ? ' danger' : elbowAngle < 85 ? ' warning' : '');
            
            // ì–´ê¹¨ ê°ë„
            const shoulderAngle = calculateAngle(
                landmarks[LANDMARKS.RIGHT_HIP],
                landmarks[LANDMARKS.RIGHT_SHOULDER],
                landmarks[LANDMARKS.RIGHT_ELBOW]
            );
            document.getElementById('shoulderAngle').textContent = `${shoulderAngle}Â°`;
            
            // ë¬´ë¦ ê°ë„ (ì™¼ìª½ - ì•ë°œ)
            const kneeAngle = calculateAngle(
                landmarks[LANDMARKS.LEFT_HIP],
                landmarks[LANDMARKS.LEFT_KNEE],
                landmarks[LANDMARKS.LEFT_ANKLE]
            );
            document.getElementById('kneeAngle').textContent = `${kneeAngle}Â°`;
            
            // ëª¸í†µ ê¸°ìš¸ê¸°
            const leftShoulder = landmarks[LANDMARKS.LEFT_SHOULDER];
            const rightShoulder = landmarks[LANDMARKS.RIGHT_SHOULDER];
            const torsoTilt = Math.round(
                Math.atan2(rightShoulder.y - leftShoulder.y, rightShoulder.x - leftShoulder.x) * 180 / Math.PI
            );
            document.getElementById('torsoTilt').textContent = `${Math.abs(torsoTilt)}Â°`;
            
            // íˆ¬êµ¬ ë‹¨ê³„
            document.getElementById('currentPhase').textContent = detectPhase(landmarks);
        }
        
        // ê´€ì ˆ ê°ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateJointStatus(landmarks) {
            if (!landmarks) {
                document.getElementById('detectedJoints').textContent = '0/33';
                document.getElementById('confidence').textContent = '--%';
                return;
            }
            
            const detected = landmarks.filter(l => l.visibility > 0.5).length;
            document.getElementById('detectedJoints').textContent = `${detected}/33`;
            
            const avgConfidence = landmarks.reduce((sum, l) => sum + l.visibility, 0) / landmarks.length;
            document.getElementById('confidence').textContent = `${Math.round(avgConfidence * 100)}%`;
        }
        
        // FPS ê³„ì‚°
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastTime = now;
            }
        }
        
        // MediaPipe ê²°ê³¼ ì²˜ë¦¬
        function onResults(results) {
            if (!isRunning) return;
            
            updateFPS();
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            
            // ë¹„ë””ì˜¤ í”„ë ˆì„ ê·¸ë¦¬ê¸°
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // ë°˜íˆ¬ëª… ì˜¤ë²„ë ˆì´
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
                    color: '#00e676',
                    lineWidth: 3
                });
                
                // ê´€ì ˆì  ê·¸ë¦¬ê¸°
                drawLandmarks(canvasCtx, results.poseLandmarks, {
                    color: '#ffffff',
                    fillColor: '#00e676',
                    lineWidth: 2,
                    radius: 5
                });
                
                // ì¸¡ì •ê°’ ì—…ë°ì´íŠ¸
                updateMeasurements(results.poseLandmarks);
                updateJointStatus(results.poseLandmarks);
            } else {
                updateJointStatus(null);
            }
            
            canvasCtx.restore();
        }
        
        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                showError(null);
                statusText.textContent = 'ì´ˆê¸°í™” ì¤‘...';
                startBtn.disabled = true;
                
                // MediaPipe Pose ì´ˆê¸°í™”
                pose = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                    }
                });
                
                pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                pose.onResults(onResults);
                
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                videoElement.srcObject = stream;
                await videoElement.play();
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘
                isRunning = true;
                processFrame();
                
                // UI ì—…ë°ì´íŠ¸
                statusDot.classList.add('active');
                statusText.textContent = 'ë¶„ì„ ì¤‘';
                startBtn.disabled = true;
                captureBtn.disabled = false;
                stopBtn.disabled = false;
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì˜¤ë¥˜:', error);
                showError('ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                startBtn.disabled = false;
            }
        }
        
        // í”„ë ˆì„ ì²˜ë¦¬
        async function processFrame() {
            if (!isRunning) return;
            
            if (videoElement.readyState >= 2) {
                await pose.send({ image: videoElement });
            }
            
            requestAnimationFrame(processFrame);
        }
        
        // ì¹´ë©”ë¼ ì¤‘ì§€
        function stopCamera() {
            isRunning = false;
            
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            // UI ì—…ë°ì´íŠ¸
            statusDot.classList.remove('active');
            statusText.textContent = 'ì¤‘ì§€ë¨';
            startBtn.disabled = false;
            captureBtn.disabled = true;
            stopBtn.disabled = true;
            
            // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        }
        
        // í”„ë ˆì„ ìº¡ì²˜
        function captureFrame() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvasElement.width;
            tempCanvas.height = canvasElement.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ë¹„ë””ì˜¤ + ì˜¤ë²„ë ˆì´ í•©ì„±
            tempCtx.drawImage(videoElement, 0, 0);
            tempCtx.drawImage(canvasElement, 0, 0);
            
            // ë‹¤ìš´ë¡œë“œ
            const link = document.createElement('a');
            link.download = `pitchcraft_capture_${Date.now()}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }
        
        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            if (message) {
                errorBox.textContent = message;
                errorBox.style.display = 'block';
            } else {
                errorBox.style.display = 'none';
            }
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
